<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>إدارة الحساب - لغتنا الأم</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@900&display=swap" rel="stylesheet">
</head>
<body>
  <main>
    <h1>إعدادات الحساب</h1>
    <div id="userSection" style="display: none;">
      <p><strong>البريد:</strong> <span id="userEmail"></span></p>
      <p><strong>الاسم الحالي:</strong> <span id="userDisplayName"></span></p>
      <p><strong>الصورة الحالية:</strong><br><img id="userPhoto" src="" alt="الصورة" width="100" /></p>

      <hr>

      <label>الاسم الجديد:</label>
      <input type="text" id="newName" placeholder="اكتب الاسم الجديد" />
      <br>

      <label>رابط الصورة الجديدة:</label>
      <input type="text" id="newPhotoURL" placeholder="رابط صورة جديدة" />
      <br>

      <button onclick="updateProfileInfo()">تحديث الاسم / الصورة</button>

      <hr>

      <label>كلمة السر الجديدة:</label>
      <input type="password" id="newPassword" placeholder="كلمة السر الجديدة" />
      <button onclick="changePassword()">تغيير كلمة السر</button>

      <hr>

      <label>كلمة السر الحالية لتأكيد الحذف:</label>
      <input type="password" id="currentPassword" placeholder="أدخل كلمة السر" />
      <button style="color:red" onclick="deleteAccount()">❌ حذف الحساب نهائيًا</button>

      <p id="statusMsg" style="color: green;"></p>
    </div>
  </main>

  <script>
    const APP_ID = "B7DE4160-73F7-4BD9-BF54-F10E6053901B";
    const API_KEY = "70E3B68F-2879-4E35-9DBF-2C9FA1F2FA9F";
    const USER_TOKEN = localStorage.getItem("user-token");
    const USER_ID = localStorage.getItem("user-id");

    const userSection = document.getElementById("userSection");
    const userEmail = document.getElementById("userEmail");
    const userDisplayName = document.getElementById("userDisplayName");
    const userPhoto = document.getElementById("userPhoto");
    const statusMsg = document.getElementById("statusMsg");

   

    // عرض بيانات المستخدم
    fetch(`https://api.backendless.com/${APP_ID}/${API_KEY}/users/${USER_ID}`, {
      headers: {
        "user-token": USER_TOKEN
      }
    })
    .then(res => {
      if (!res.ok) throw new Error("غير مسموح");
      return res.json();
    })
    .then(user => {
      userSection.style.display = "block";
      userEmail.textContent = user.email;
      userDisplayName.textContent = user.name || "غير محدد";
      userPhoto.src = user.photo || "";
    })
    .catch(() => {
      window.location.href = #;
    });

    // تحديث الاسم والصورة
    function updateProfileInfo() {
      const newName = document.getElementById("newName").value;
      const newPhotoURL = document.getElementById("newPhotoURL").value;

      fetch(`https://api.backendless.com/${APP_ID}/${API_KEY}/users/${USER_ID}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "user-token": USER_TOKEN
        },
        body: JSON.stringify({
          name: newName,
          photo: newPhotoURL
        })
      })
      .then(res => res.json())
      .then(() => {
        statusMsg.style.color = "green";
        statusMsg.textContent = "✅ تم التحديث بنجاح.";
        if (newName) userDisplayName.textContent = newName;
        if (newPhotoURL) userPhoto.src = newPhotoURL;
      })
      .catch(() => {
        statusMsg.style.color = "red";
        statusMsg.textContent = "❌ حدث خطأ في التحديث.";
      });
    }

    // تغيير كلمة السر
    function changePassword() {
      const newPassword = document.getElementById("newPassword").value;
      if (newPassword.length < 6) return alert("كلمة السر يجب أن تكون 6 أحرف على الأقل.");

      fetch(`https://api.backendless.com/${APP_ID}/${API_KEY}/users/${USER_ID}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "user-token": USER_TOKEN
        },
        body: JSON.stringify({
          password: newPassword
        })
      })
      .then(res => res.json())
      .then(() => {
        statusMsg.style.color = "green";
        statusMsg.textContent = "✅ تم تغيير كلمة السر.";
      })
      .catch(() => {
        statusMsg.style.color = "red";
        statusMsg.textContent = "❌ فشل في تغيير كلمة السر.";
      });
    }

    // حذف الحساب
    function deleteAccount() {
      const password = document.getElementById("currentPassword").value;
      if (!password) return alert("أدخل كلمة السر لتأكيد الحذف.");

      // تسجيل الدخول لتأكيد الباسورد
      fetch(`https://api.backendless.com/${APP_ID}/${API_KEY}/users/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          login: userEmail.textContent,
          password: password
        })
      })
      .then(res => {
        if (!res.ok) throw new Error("كلمة السر غير صحيحة");
        return fetch(`https://api.backendless.com/${APP_ID}/${API_KEY}/users/${USER_ID}`, {
          method: "DELETE",
          headers: {
            "user-token": USER_TOKEN
          }
        });
      })
      .then(() => {
        alert("✅ تم حذف الحساب.");
        localStorage.clear();
        window.location.href = "login.html";
      })
      .catch(err => {
        statusMsg.style.color = "red";
        statusMsg.textContent = "❌ فشل حذف الحساب: " + err.message;
      });
    }
  </script>
</body>
</html>
